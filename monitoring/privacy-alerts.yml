# Privacy-specific alerting rules for Privacy-Preserving Agent Fine-Tuner
# These rules monitor privacy budget consumption, compliance violations, and security events

groups:
  - name: privacy_budget_alerts
    rules:
      - alert: PrivacyBudgetNearExhaustion
        expr: |
          (
            privacy_budget_consumed / privacy_budget_total
          ) > 0.8
        for: 1m
        labels:
          severity: warning
          component: privacy_engine
          category: budget_management
        annotations:
          summary: "Privacy budget is nearly exhausted"
          description: |
            Privacy budget consumption is at {{ $value | humanizePercentage }} 
            for session {{ $labels.session_id }}. 
            Consider stopping training or increasing budget allocation.
          runbook_url: "https://docs.your-org.com/runbooks/privacy-budget-exhaustion"

      - alert: PrivacyBudgetExhausted
        expr: |
          privacy_budget_consumed >= privacy_budget_total
        for: 0s
        labels:
          severity: critical
          component: privacy_engine
          category: budget_management
        annotations:
          summary: "Privacy budget completely exhausted"
          description: |
            Privacy budget has been completely exhausted for session {{ $labels.session_id }}.
            Training must be stopped immediately to maintain privacy guarantees.
          runbook_url: "https://docs.your-org.com/runbooks/privacy-budget-exhausted"

      - alert: PrivacyBudgetLeakage
        expr: |
          increase(privacy_budget_consumed[5m]) > 
          increase(training_steps_total[5m]) * expected_budget_per_step
        for: 2m
        labels:
          severity: warning
          component: privacy_engine
          category: budget_management
        annotations:
          summary: "Unexpected privacy budget consumption rate"
          description: |
            Privacy budget is being consumed faster than expected.
            Current rate: {{ $value | humanize }} epsilon per 5 minutes.
            This may indicate a privacy accounting error or attack.

  - name: differential_privacy_alerts
    rules:
      - alert: NoiseGenerationFailure
        expr: |
          privacy_noise_generation_failures_total > 0
        for: 0s
        labels:
          severity: critical
          component: dp_mechanism
          category: privacy_protection
        annotations:
          summary: "Differential privacy noise generation failed"
          description: |
            Noise generation for differential privacy has failed {{ $value }} times.
            This compromises privacy guarantees and training must be stopped.

      - alert: GradientClippingDisabled
        expr: |
          gradient_clipping_enabled == 0
        for: 1m
        labels:
          severity: critical
          component: dp_mechanism
          category: privacy_protection
        annotations:
          summary: "Gradient clipping is disabled"
          description: |
            Gradient clipping is disabled, which violates differential privacy requirements.
            Enable gradient clipping immediately to maintain privacy guarantees.

      - alert: EpsilonDeltaViolation
        expr: |
          privacy_epsilon_consumed > privacy_epsilon_budget or
          privacy_delta_consumed > privacy_delta_budget
        for: 0s
        labels:
          severity: critical
          component: privacy_accountant
          category: privacy_violation
        annotations:
          summary: "Privacy parameters exceeded allowed bounds"
          description: |
            Privacy parameters have exceeded configured bounds.
            ε: {{ .privacy_epsilon_consumed }} / {{ .privacy_epsilon_budget }}
            δ: {{ .privacy_delta_consumed }} / {{ .privacy_delta_budget }}

  - name: federated_learning_alerts
    rules:
      - alert: FederatedClientDropout
        expr: |
          federated_active_clients < federated_min_clients
        for: 5m
        labels:
          severity: warning
          component: federated_coordinator
          category: availability
        annotations:
          summary: "Insufficient federated learning clients"
          description: |
            Only {{ $value }} federated clients are active, 
            but minimum {{ $labels.min_clients }} required for training.

      - alert: FederatedAggregationFailure
        expr: |
          increase(federated_aggregation_failures_total[10m]) > 0
        for: 1m
        labels:
          severity: critical
          component: federated_coordinator
          category: system_health
        annotations:
          summary: "Federated learning aggregation failures detected"
          description: |
            {{ $value }} federated aggregation failures in the last 10 minutes.
            This may indicate Byzantine clients or network issues.

      - alert: SecureAggregationCompromised
        expr: |
          secure_aggregation_integrity_check == 0
        for: 0s
        labels:
          severity: critical
          component: secure_aggregation
          category: security
        annotations:
          summary: "Secure aggregation integrity check failed"
          description: |
            Secure aggregation integrity check has failed.
            This may indicate a security breach or malicious client behavior.

  - name: compliance_alerts
    rules:
      - alert: GDPRComplianceViolation
        expr: |
          gdpr_compliance_violations_total > gdpr_compliance_violations_total offset 1m
        for: 0s
        labels:
          severity: critical
          component: compliance_monitor
          category: regulatory
        annotations:
          summary: "GDPR compliance violation detected"
          description: |
            A GDPR compliance violation has been detected.
            Violation type: {{ $labels.violation_type }}
            Immediate remediation required.

      - alert: HIPAAComplianceViolation
        expr: |
          hipaa_compliance_violations_total > hipaa_compliance_violations_total offset 1m
        for: 0s
        labels:
          severity: critical
          component: compliance_monitor
          category: regulatory
        annotations:
          summary: "HIPAA compliance violation detected"
          description: |
            A HIPAA compliance violation has been detected.
            PHI exposure risk: {{ $labels.risk_level }}
            Immediate containment required.

      - alert: DataRetentionPolicyViolation
        expr: |
          data_retention_violations_total > 0
        for: 5m
        labels:
          severity: warning
          component: data_governance
          category: regulatory
        annotations:
          summary: "Data retention policy violation"
          description: |
            {{ $value }} data items exceed retention policy limits.
            Automated cleanup may be required.

  - name: security_alerts
    rules:
      - alert: PrivacyAttackDetected
        expr: |
          privacy_attack_score > privacy_attack_threshold
        for: 1m
        labels:
          severity: critical
          component: attack_detector
          category: security
        annotations:
          summary: "Potential privacy attack detected"
          description: |
            Privacy attack detection score: {{ $value }}
            Attack type: {{ $labels.attack_type }}
            Source: {{ $labels.source_ip }}

      - alert: MembershipInferenceRisk
        expr: |
          membership_inference_risk_score > 0.7
        for: 2m
        labels:
          severity: warning
          component: privacy_analyzer
          category: security
        annotations:
          summary: "High membership inference attack risk"
          description: |
            Membership inference attack risk score: {{ $value }}
            Model may be vulnerable to membership inference attacks.

      - alert: ModelInversionRisk
        expr: |
          model_inversion_risk_score > 0.8
        for: 2m
        labels:
          severity: warning
          component: privacy_analyzer
          category: security
        annotations:
          summary: "High model inversion attack risk"
          description: |
            Model inversion attack risk score: {{ $value }}
            Model may be leaking training data through inversion attacks.

  - name: system_health_alerts
    rules:
      - alert: PrivacyEngineDown
        expr: |
          up{job="privacy-finetuner"} == 0
        for: 1m
        labels:
          severity: critical
          component: privacy_engine
          category: availability
        annotations:
          summary: "Privacy engine is down"
          description: |
            Privacy-preserving agent finetuner service is not responding.
            All privacy-dependent operations are affected.

      - alert: HighPrivacyComputeLatency
        expr: |
          privacy_compute_duration_seconds > 30
        for: 2m
        labels:
          severity: warning
          component: privacy_engine
          category: performance
        annotations:
          summary: "High privacy computation latency"
          description: |
            Privacy computation is taking {{ $value }}s, which is above the 30s threshold.
            This may impact training performance.

      - alert: PrivacyAccountingError
        expr: |
          increase(privacy_accounting_errors_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          component: privacy_accountant
          category: system_health
        annotations:
          summary: "Privacy accounting errors detected"
          description: |
            {{ $value }} privacy accounting errors in the last 5 minutes.
            Privacy guarantees may be compromised.

  - name: resource_alerts
    rules:
      - alert: PrivacyComputeResourceExhaustion
        expr: |
          privacy_compute_cpu_usage > 0.9 or
          privacy_compute_memory_usage > 0.9
        for: 5m
        labels:
          severity: warning
          component: resource_manager
          category: resource_exhaustion
        annotations:
          summary: "Privacy compute resources nearly exhausted"
          description: |
            Privacy compute resources are at {{ $value | humanizePercentage }} utilization.
            Consider scaling up or optimizing privacy computations.

      - alert: GPUMemoryExhaustion
        expr: |
          gpu_memory_usage_ratio > 0.95
        for: 2m
        labels:
          severity: critical
          component: gpu_manager
          category: resource_exhaustion
        annotations:
          summary: "GPU memory nearly exhausted"
          description: |
            GPU memory usage is at {{ $value | humanizePercentage }}.
            Training may fail or performance may degrade significantly.

  - name: data_quality_alerts
    rules:
      - alert: PIIDetectedInTrainingData
        expr: |
          pii_detection_score > pii_detection_threshold
        for: 0s
        labels:
          severity: critical
          component: data_sanitizer
          category: data_quality
        annotations:
          summary: "PII detected in training data"
          description: |
            Personally Identifiable Information detected in training data.
            PII types: {{ $labels.pii_types }}
            Data sanitization required before training.

      - alert: DataQualityDegradation
        expr: |
          data_quality_score < 0.8
        for: 5m
        labels:
          severity: warning
          component: data_validator
          category: data_quality
        annotations:
          summary: "Training data quality degradation"
          description: |
            Data quality score has dropped to {{ $value }}.
            This may impact model performance and privacy guarantees.

# Global alert configuration
global:
  # Notification channels
  slack_api_url: 'YOUR_SLACK_WEBHOOK_URL'
  pagerduty_url: 'YOUR_PAGERDUTY_URL'
  
  # Alert routing rules
  route:
    group_by: ['alertname', 'severity', 'component']
    group_wait: 10s
    group_interval: 10s
    repeat_interval: 1h
    receiver: 'default'
    routes:
      - match:
          severity: critical
        receiver: 'critical-alerts'
        continue: true
      - match:
          category: privacy_violation
        receiver: 'privacy-team'
        continue: true
      - match:
          category: regulatory
        receiver: 'compliance-team'
        continue: true

# Notification receivers
receivers:
  - name: 'default'
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#privacy-alerts'
        title: 'Privacy-Preserving ML Alert'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'

  - name: 'critical-alerts'
    pagerduty_configs:
      - service_key: '{{ .pagerduty_url }}'
        description: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#critical-privacy-alerts'
        title: '🚨 CRITICAL Privacy Alert'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'

  - name: 'privacy-team'
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#privacy-engineering'
        title: '🔒 Privacy Violation Alert'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'

  - name: 'compliance-team'
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#compliance'
        title: '⚖️ Compliance Alert'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'